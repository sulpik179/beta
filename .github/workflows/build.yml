name: ğŸ› ï¸ Build Beta APK
on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:  # allow manual run

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # ğŸ”‘ Critical: set ANDROID_HOME explicitly
      ANDROID_HOME: ${{ github.workspace }}/.buildozer/android/platform/android-sdk
      ANDROID_SDK_ROOT: ${{ github.workspace }}/.buildozer/android/platform/android-sdk

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git zip unzip openjdk-17-jdk \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake libffi-dev

      - name: ğŸ§° Install Buildozer & Cython
        run: |
          pip install --upgrade pip
          pip install buildozer==1.5.0 cython==3.0.10

      # ğŸ” Cache Android SDK (speeds up subsequent runs)
      - name: ğŸ—ƒï¸ Cache Android SDK
        uses: actions/cache@v4
        id: cache-sdk
        with:
          path: ${{ env.ANDROID_HOME }}
          key: android-sdk-34-ndk25b-v2

      # ğŸ› ï¸ Install cmdline-tools ONLY if not cached
      - name: ğŸ”§ Set up Android SDK (cmdline-tools)
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$ANDROID_HOME"
          cd "$ANDROID_HOME"

          # Remove leftovers
          rm -rf cmdline-tools 2>/dev/null || true

          # Download and extract
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-*.zip
          rm commandlinetools-linux-*.zip

          # Fix dir structure â†’ cmdline-tools/latest/
          mv cmdline-tools cmdline-tools-latest
          mkdir -p cmdline-tools
          mv cmdline-tools-latest cmdline-tools/latest

      - name: âœ… Verify sdkmanager
        run: |
          if [ ! -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "âŒ sdkmanager not found!"
            exit 1
          fi
          echo "âœ… sdkmanager OK"

      - name: ğŸ“œ Accept Android SDK licenses
        run: |
          mkdir -p "$ANDROID_HOME/licenses"
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
          echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"

      - name: ğŸ“² Install Android packages
        run: |
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;25.2.9519653"

      - name: ğŸ” Verify aidl exists
        run: |
          AIDL_PATH="$ANDROID_HOME/build-tools/34.0.0/aidl"
          if [ ! -f "$AIDL_PATH" ]; then
            echo "âŒ aidl NOT FOUND at $AIDL_PATH"
            ls -la "$ANDROID_HOME/build-tools/"
            exit 1
          fi
          echo "âœ… aidl found at: $AIDL_PATH"

      - name: ğŸ—ï¸ Build APK (debug)
        run: |
          buildozer -v android debug

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: beta-debug-apk
          path: bin/*.apk
          retention-days: 7

      # ğŸ—ƒï¸ Cache .buildozer (except SDK â€” already cached separately)
      - name: ğŸ—ƒï¸ Cache .buildozer (Python deps, NDK, etc.)
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-python311-kivy230-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-python311-kivy230-
